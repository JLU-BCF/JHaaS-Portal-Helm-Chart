apiVersion: batch/v1
kind: CronJob
metadata:
  creationTimestamp: null
  labels:
    {{ .Release.Name }}.cron: {{ .Release.Name }}-tf-dispatcher
  name: {{ .Release.Name }}-tf-dispatcher
spec:
  # TODO: this is testing! Use proper schedule for prod!!!
  schedule: "*/5 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 5
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        metadata:
          creationTimestamp: null
          labels:
            {{ .Release.Name }}.cron: {{ .Release.Name }}-tf-dispatcher
        spec:
          serviceAccountName: acc-{{ .Release.Name }}-tf-job-spawner
          hostname: {{ .Release.Name }}-tf-dispatcher
          imagePullSecrets:
            - name: sec-{{ .Release.Name }}-registry-credentials
          restartPolicy: Never
          containers:
            - image: "{{ .Values.backend.image.registry }}/{{ .Values.backend.image.repository }}:{{ .Values.backend.image.tag }}"
              imagePullPolicy: {{ .Values.backend.image.pullPolicy }}
              name: {{ .Release.Name }}-tf-dispatcher
              resources: {}
              # TODO: this is testing! Use proper command for prod!!!
              command: ['/usr/local/bin/node', '/jhaas-app/dist/jobs/ProccessRequestsJob.js']
              env:
                - name: NODE_ENV
                  valueFrom:
                    configMapKeyRef:
                      key: NODE_ENV
                      name: env-{{ .Release.Name }}-backend
                - name: SERVER_PORT
                  valueFrom:
                    configMapKeyRef:
                      key: SERVER_PORT
                      name: env-{{ .Release.Name }}-backend
                - name: RELEASE_NAME
                  valueFrom:
                    configMapKeyRef:
                      key: RELEASE_NAME
                      name: env-{{ .Release.Name }}-backend
                # Kubernetes
                - name: K8S_TF_IMAGE
                  valueFrom:
                    configMapKeyRef:
                      key: K8S_TF_IMAGE
                      name: env-{{ .Release.Name }}-tf-dispatcher
                - name: K8S_TF_NS
                  valueFrom:
                    configMapKeyRef:
                      key: K8S_TF_NS
                      name: env-{{ .Release.Name }}-tf-dispatcher
                # S3 Connection
                - name: S3_ENDPOINT
                  valueFrom:
                    configMapKeyRef:
                      key: S3_ENDPOINT
                      name: env-{{ .Release.Name }}-tf-dispatcher
                - name: S3_PORT
                  valueFrom:
                    configMapKeyRef:
                      key: S3_PORT
                      name: env-{{ .Release.Name }}-tf-dispatcher
                - name: S3_SSL
                  valueFrom:
                    configMapKeyRef:
                      key: S3_SSL
                      name: env-{{ .Release.Name }}-tf-dispatcher
                - name: S3_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      key: access_key
                      name: sec-{{ .Release.Name }}-s3-conf
                - name: S3_SECRET_KEY
                  valueFrom:
                    secretKeyRef:
                      key: secret_key
                      name: sec-{{ .Release.Name }}-s3-conf
                # S3 Buckets
                - name: S3_JH_SPECS_BUCKET
                  valueFrom:
                    configMapKeyRef:
                      key: S3_JH_SPECS_BUCKET
                      name: env-{{ .Release.Name }}-tf-dispatcher
                # Secret Names
                - name: S3_SECRET_NAME
                  value: sec-{{ .Release.Name }}-s3-conf
                - name: TF_SECRET_NAME
                  value: sec-{{ .Release.Name }}-tf-conf
                # POSTGRES
                - name: POSTGRES_HOST
                  valueFrom:
                    configMapKeyRef:
                      key: POSTGRES_HOST
                      name: env-{{ .Release.Name }}-db
                - name: POSTGRES_PORT
                  valueFrom:
                    configMapKeyRef:
                      key: POSTGRES_PORT
                      name: env-{{ .Release.Name }}-db
                - name: POSTGRES_DB
                  valueFrom:
                    secretKeyRef:
                      key: POSTGRES_DB
                      name: sec-{{ .Release.Name }}-db
                - name: POSTGRES_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      key: POSTGRES_PASSWORD
                      name: sec-{{ .Release.Name }}-db
                - name: POSTGRES_USER
                  valueFrom:
                    secretKeyRef:
                      key: POSTGRES_USER
                      name: sec-{{ .Release.Name }}-db
