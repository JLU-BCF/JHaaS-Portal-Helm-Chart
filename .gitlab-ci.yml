variables:
  HELM_CHART_DIR: ${CI_PROJECT_DIR}
  HELM_CHART_NAME: jhaas-portal
  HELM_CHART_CHANNEL: ${CI_COMMIT_REF_SLUG}
  HELM_CHART_VERSION: 0.1.1

stages:
  - package

helm-package:
  stage: package
  image: alpine:3.18
  script:
    - apk add --no-cache helm
    - cp values.example.yaml values.yaml
    - mkdir -p /root/.config/helm/registry

    # Setup Secrets
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"},\"$HARBOR_HOST\":{\"username\":\"$HARBOR_USERNAME\",\"password\":\"$HARBOR_PASSWORD\"}}}" > /root/.config/helm/registry/config.json

    # Package Helm Chart
    - tar -vczf /tmp/${HELM_CHART_NAME}-${HELM_CHART_CHANNEL}-${HELM_CHART_VERSION}.tgz
      -C ${HELM_CHART_DIR}
      --exclude=./.git
      --exclude=./.gitignore
      --exclude=./.gitlab-ci.yml
      --exclude=./.helmignore
      --exclude=./values.example.yaml
      .

    # Push chart to GitLab
    # - 'curl --request "POST"
    #   --user "gitlab-ci-token:$CI_JOB_TOKEN"
    #   --form "chart=@/tmp/${HELM_CHART_NAME}-${HELM_CHART_CHANNEL}-${HELM_CHART_VERSION}.tgz"
    #   "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/helm/api/${HELM_CHART_CHANNEL}/charts"'


    # Push chart to GitLab
    - helm push "/tmp/${HELM_CHART_NAME}-${HELM_CHART_CHANNEL}-${HELM_CHART_VERSION}.tgz" "oci://$CI_REGISTRY/$CI_PROJECT_PATH"


    # Push chart to harbor
    - helm push "/tmp/${HELM_CHART_NAME}-${HELM_CHART_CHANNEL}-${HELM_CHART_VERSION}.tgz" "$HARBOR_OCI/$HARBOR_PROJECT"
